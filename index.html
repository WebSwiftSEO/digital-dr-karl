<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Digital Dr Karl üßë‚Äçüî¨</title>

    <!-- SEO Metadata -->
    <meta name="description" content="Digital Dr Karl ‚Äì Analyze X profiles and detect bots using AI and the X API! ü§ñ‚ö°">
    <meta name="keywords" content="Digital Dr Karl, X bot detector, X profile analyzer, AI insights, bot detection, Dr Karl, Aussie humor">
    <meta property="og:title" content="Digital Dr Karl üßë‚Äçüî¨">
    <meta property="og:description" content="Analyze X profiles with Digital Dr Karl and expose bots using real data.">
    <meta name="twitter:card" content="summary_large_image">

    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ... Your existing styles remain unchanged ... */
    </style>
</head>
<body>
    <div class="container">
        <h1>Digital Dr Karl üßë‚Äçüî¨</h1>
        <p>Analyze X profiles, detect bots, and have a laugh! ü§ñ‚ö°</p>
        <input type="text" id="username" placeholder="Enter X Username or URL">
        <button onclick="analyzeProfile()">Analyze</button>
        <div id="result"></div>
        <div id="botChartContainer">
            <canvas id="botChart"></canvas>
        </div>
    </div>

    <button class="share-btn" onclick="shareDoctorKarl()">üì§ Share Digital Dr Karl</button>

    <script>
        const proxyURL = 'https://wooden-canyon-lunch.glitch.me/';
        const bearerToken = 'YOUR_BEARER_TOKEN_HERE'; // Replace with actual token

        async function analyzeProfile() {
            const usernameInput = document.getElementById('username').value.trim();
            const resultDiv = document.getElementById('result');
            const chartContainer = document.getElementById('botChartContainer');
            let existingChart = Chart.getChart('botChart'); // Get existing chart instance

            // Clear previous results and chart
            resultDiv.innerHTML = '';
            chartContainer.style.display = 'none';
            if (existingChart) {
                existingChart.destroy(); // Destroy existing chart to prevent overlap
            }

            if (!usernameInput) {
                resultDiv.innerHTML = "<span style='color: red;'>Please enter a username.</span>";
                return;
            }

            // Improved username cleaning
            let cleanUsername = usernameInput
                .replace(/^https?:\/\/(www\.)?(x\.com|twitter\.com)\//i, '')
                .replace(/^@/, '')
                .trim();

            if (!cleanUsername) {
                resultDiv.innerHTML = "<span style='color: red;'>Invalid username format.</span>";
                return;
            }

            resultDiv.innerHTML = "<p>Analyzing...</p>";

            try {
                const apiUrl = `https://api.twitter.com/2/users/by/username/${encodeURIComponent(cleanUsername)}?user.fields=public_metrics,created_at`;

                const response = await fetch(`${proxyURL}${apiUrl}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${bearerToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status: ${response.status}`);
                }

                const data = await response.json();

                if (!data.data) {
                    resultDiv.innerHTML = `<span style="color: red;">‚ùå User not found or API error: ${data.errors?.[0]?.message || 'Unknown error'}</span>`;
                    return;
                }

                const { public_metrics, created_at } = data.data;

                // More nuanced bot scoring
                let botScore = 0;
                const accountAge = (new Date() - new Date(created_at)) / (1000 * 60 * 60 * 24 * 365); // Age in years
                
                if (public_metrics.followers_count < 50) botScore += 20;
                if (public_metrics.following_count > public_metrics.followers_count * 5) botScore += 20;
                if (public_metrics.tweet_count < 10 && accountAge > 0.5) botScore += 20;
                if (accountAge < 0.5) botScore += 20;
                if (public_metrics.followers_count === 0 && public_metrics.tweet_count > 100) botScore += 20;

                botScore = Math.min(botScore, 100); // Cap at 100%

                resultDiv.innerHTML = `
                    <p><strong>Username:</strong> ${data.data.username}</p>
                    <p><strong>Followers:</strong> ${public_metrics.followers_count.toLocaleString()}</p>
                    <p><strong>Following:</strong> ${public_metrics.following_count.toLocaleString()}</p>
                    <p><strong>Total Tweets:</strong> ${public_metrics.tweet_count.toLocaleString()}</p>
                    <p><strong>Account Created:</strong> ${new Date(created_at).toDateString()}</p>
                    <p><strong>ü§ñ Bot Probability:</strong> ${botScore}%</p>
                    <p>${botScore > 60 ? '‚öîÔ∏è Bot Alert!' : botScore > 30 ? 'ü§î Suspicious' : '‚úÖ Looks Human!'}</p>
                `;

                chartContainer.style.display = "block";
                createChart(public_metrics.followers_count, public_metrics.following_count, public_metrics.tweet_count, botScore);

            } catch (error) {
                console.error("Error:", error);
                resultDiv.innerHTML = `<span style="color: red;">Error: ${error.message}</span>`;
            }
        }

        function createChart(followers, following, tweets, botScore) {
            const ctx = document.getElementById('botChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Followers', 'Following', 'Tweets', 'Bot Score'],
                    datasets: [{
                        label: 'Bot Analysis',
                        data: [followers, following, tweets, botScore],
                        backgroundColor: ['green', 'gold', 'gold', botScore > 60 ? 'red' : botScore > 30 ? 'orange' : 'green']
                    }]
                },
                options: {
                    animation: {
                        duration: 1000,
                        easing: 'easeOutBounce'
                    },
                    responsive: true,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count / Percentage'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'gold'
                            }
                        }
                    }
                }
            });
        }

        function shareDoctorKarl() {
            if (navigator.share) {
                navigator.share({
                    title: "Digital Dr Karl",
                    text: "Check out this X profile analyzer!",
                    url: window.location.href
                }).catch(err => console.log('Error sharing:', err));
            } else {
                alert("Sharing not supported on this browser. Copy this URL to share: " + window.location.href);
            }
        }

        // Add enter key support
        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeProfile();
            }
        });
    </script>
</body>
</html>
